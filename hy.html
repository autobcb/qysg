<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>海洋听书</title>
</head>
<body>

</body>
<script src="https://vc.jd.com/web/js/jquery-3.1.1.min.js"></script>
<!--如果要引入外部 js 必须在书源代码的上面-->
<script>
    var isCookieJar=true;// 不需要CookieJar请修改此处
    class FlutterJSBridge {
        constructor() {
            this.init(); //前台webview 里必须删除这行
        }

        init() {
            if (window.flutter_inappwebview) {
                this.isReady = true;
                this.CookieJar();
            } else {
                window.addEventListener('flutterInAppWebViewPlatformReady', () => {
                    this.isReady = true;
                    console.log('JSBridge初始化完成');
                    this.CookieJar();
                });
            }
        }

        //通知原生页面初始化完成，仅在书源和tts生效，webview请勿使用，只有通知加载成功后才允许运行，否则会一直等待加载成功
        async CookieJar() {
            try {
                await window.flutter_inappwebview.callHandler('CookieJar', isCookieJar);
            } catch (error) {
                console.error('汇报完成准备失败:', error);
            }
        }

        //获取应用编译版本
        async getbuildNumber() {
            try {
                return await window.flutter_inappwebview.callHandler('buildNumber');
            } catch (error) {
                return  0;
            }
        }

        //获取应用版本
        async getversion() {
            try {
                return await window.flutter_inappwebview.callHandler('version');
            } catch (error) {
                return  "0.0.0";
            }
        }

        //获取设备唯一id
        async getDeviceid() {
            try {
                return await window.flutter_inappwebview.callHandler('id');
            } catch (error) {
                return  "";
            }
        }

        //获取设备平台 此处返回 windows、macos、ios、ohos、android
        async getDevice() {
            try {
                return await window.flutter_inappwebview.callHandler('device');
            } catch (error) {
                return  "";
            }
        }

        //输出日志,前台webview请勿使用
        //str 为 String
        async log(str) {
            try {
                return await window.flutter_inappwebview.callHandler('log',str);
            } catch (error) {
                return  false;
            }
        }

        //书源调试时可输出 html 代码到前台
        //type 0 搜索源码 ， 1详情源码 ，2目录源码 ，3正文源码
        //str 为 String
        //type 为int
        async text(type,str) {
            try {
                return await window.flutter_inappwebview.callHandler('text',type,str);
            } catch (error) {
                return  false;
            }
        }

        //toast弹窗
        //str 为 String
        async showToast(str) {
            try {
                return await window.flutter_inappwebview.callHandler('showToast',str);
            } catch (error) {
                return  false;
            }
        }

        //获取默认ua
        async getWebViewUA() {
            try {
                return await window.flutter_inappwebview.callHandler('getWebViewUA');
            } catch (error) {
                return  "";
            }
        }

        //通过url打开外部应用
        //url 为 String
        async openurl(url) {
            try {
                return await window.flutter_inappwebview.callHandler('openurl',url,"");
            } catch (error) {
                return  false;
            }
        }

        //通过url打开外部应用并附带mimeType
        //url 为 String
        //mimeType 为 String
        async openurlwithMimeType(url,mimeType) {
            try {
                return await window.flutter_inappwebview.callHandler('openurl',url,mimeType);
            } catch (error) {
                return  false;
            }
        }

        /**
         * 使用webView访问网络
         * @param html 直接用webView载入的html, 如果html为空直接访问url
         * @param url html内如果有相对路径的资源不传入url访问不了
         * @param js 用来取返回值的js语句, 没有就返回整个源代码
         * @param body 当参数不为空的时候，会以post请求，此时请务必在 header 中带上content-type
         * @param header 请求的header头，此参数必须是json字符串
         * @return 返回js获取的内容
         */
        async webview(url,js,html,body,header) {
            try {
                return await window.flutter_inappwebview.callHandler('webview',url,js,html,body,header,"","");
            } catch (error) {
                return  "";
            }
        }

        /**
         * overrideUrlRegex 为正则表达式
         * 使用方法和上面的一样
         * 但返回的内容为正则到的内容，如果无法正则到则返回 js 获取的内容，如果 js 为空则返回页面 html
         */
        async webViewGetOverrideUrl(url,js,html,body,header,overrideUrlRegex) {
            try {
                return await window.flutter_inappwebview.callHandler('webview',url,js,html,body,header,overrideUrlRegex,"");
            } catch (error) {
                return  "";
            }
        }

        /**
         * 使用webView获取资源url
         * urlregex 为正则表达式
         * 使用方法和上面的一样
         * 但返回的内容为正则到的内容，如果无法正则到则返回 js 获取的内容，如果 js 为空则返回页面 html
         */
        async webViewGetSource(url,js,html,body,header,urlregex) {
            try {
                return await window.flutter_inappwebview.callHandler('webview',url,js,html,body,header,"",urlregex);
            } catch (error) {
                return  "";
            }
        }


        /**
         * 启动前台 webview 访问链接并获取结束时的 html，可用于手工过盾
         * @param url 网址
         * @param title 标题
         * @param header 请求的header头，此参数必须是json字符串
         * @return 返回网页的内容
         */
        async startBrowser(url,title,header) {
            try {
                return await window.flutter_inappwebview.callHandler('startBrowser',url,title,header);
            } catch (error) {
                return  "";
            }
        }

        //专门为段评设置的半屏显示，不返回任何东西
        async startBrowserDp(url,title) {
            try {
                return await window.flutter_inappwebview.callHandler('startBrowserDp',url,title);
            } catch (error) {
                return  "";
            }
        }

        //仅前台webview可以使用，返回按钮，返回上一个页面
        async back() {
            try {
                return await window.flutter_inappwebview.callHandler('back');
            } catch (error) {
                return  false;
            }
        }

        //将 utf8字符串转到 gbk 并 url 编码
        async utf8ToGbkUrlEncoded(str) {
            try {
                return await window.flutter_inappwebview.callHandler('utf8ToGbkUrlEncoded',str);
            } catch (error) {
                return  "";
            }
        }

        /*
        * @param str为图片链接
        * @param header 请求的header头，此参数必须是json字符串
        * 此函数是让用户输入图片中的验证码，当链接为空则直接让用户输入验证码
        */
        async getVerificationCode(str,header) {
            try {
                return await window.flutter_inappwebview.callHandler('getVerificationCode',str,header);
            } catch (error) {
                return  "";
            }
        }

        //提交内容书本信息 json 后的字符串
        async addbook(book) {
            try {
                return await window.flutter_inappwebview.callHandler('addbook',book);
            } catch (error) {
                return  "";
            }
        }

    }

    //webview请勿使用
    //以下提交的url，headers,body 都必须为字符串,headers必须为json字符串
    //当followRedirects 为 false 时不处理重定向，当为 true 时会自动处理重定向 ，如不明白用途直接用 true 最佳
    // 以下所有参数除当followRedirects外均为 String
    class Http {
        constructor() {}

        /*
         * 通用返回字段
         * method post get 或者 head
         * body 请求返回后的字节的 base64
         * headers  map<String,List<String>> 可通过headers[""]来或者
         * statusCode 状态码
         * statusMessage
         * data 返回后的字节 格式化后的内容
         */
        async Get(url,headers,followRedirects) {
            try {
                return await window.flutter_inappwebview.callHandler('http',"get",url,"",JSON.stringify(headers),followRedirects,"");
            } catch (error) {
                return  null;
            }
        }

        async Head(url,headers,followRedirects) {
            try {
                return await window.flutter_inappwebview.callHandler('http',"head",url,"",JSON.stringify(headers),followRedirects,"");
            } catch (error) {
                return  null;
            }
        }


        async Post(url,headers,body,contenttype,followRedirects) {
            try {
                return await window.flutter_inappwebview.callHandler('http',"post",url,body,JSON.stringify(headers),followRedirects,contenttype);
            } catch (error) {
                return  null;
            }
        }
    }

    class Cache {
        constructor() {}
        async get(key) {
            try {
                return await window.flutter_inappwebview.callHandler('cache.get',key);
            } catch (error) {
                return  null;
            }
        }

        async set(key,value) {
            try {
                return await window.flutter_inappwebview.callHandler('cache.set',key,value);
            } catch (error) {
                return  null;
            }
        }

        async remove(key) {
            try {
                return await window.flutter_inappwebview.callHandler('cache.remove',key);
            } catch (error) {
                return  null;
            }
        }

        //如果登录为弹窗格式的，里面输入框输入的内容可以通过这个函数获取，默认返回的json格式或者为空，需要自行转换
        async getLoginInfo(){
            return await  this.get("LoginInfo")
        }

        //将修改后的弹窗输入内容报错 ，必须 JSON.stringify，不然会出错
        async putLoginInfo(info){
            return await  this.set("LoginInfo",info)
        }

        //获取书本变量
        async getbookVariable(bookurl){
            return await  this.get(bookurl)
        }

        //写入书本变量
        async setbookVariable(bookurl,value){
            return await  this.set(bookurl,value)
        }
    }

    class Cookie {
        constructor() {}

        //通过url获取当前url的所有cookie
        async get(url) {
            try {
                return await window.flutter_inappwebview.callHandler('cookie.get',url);
            } catch (error) {
                return  null;
            }
        }

        //通过url删除当前url的所有cookie
        async remove(url) {
            try {
                return await window.flutter_inappwebview.callHandler('cookie.remove',url);
            } catch (error) {
                return  null;
            }
        }


        //通过url保存当前url的所有cookie
        async set(url,value) {
            try {
                return await window.flutter_inappwebview.callHandler('cookie.set',url,value);
            } catch (error) {
                return  null;
            }
        }

        //通过 url 获取单个 cookie 的值
        async getCookie(url,value) {
            try {
                return await window.flutter_inappwebview.callHandler('cookie.getCookie',url,value);
            } catch (error) {
                return  null;
            }
        }
    }

    //安全的创建一个 div 解析 html
    function parseHTMLSafely(htmlStr) {
        try {
            // 在函数作用域内创建独立的临时容器
            // 每个调用创建新的jQuery对象，互不影响
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlStr;
            return $(tempDiv);
        } catch (e) {
            flutterBridge.log("HTML解析错误:"+e.message);
            return $('<div>');
        }
    }

    //parseHTMLSafely 创建的用完后必须删除
    function removeHTMLSafely(tempContainer) {
        try {
            tempContainer.innerHTML = '';
            if (tempContainer.parentNode) {
                tempContainer.parentNode.removeChild(tempContainer);
            }
        } catch (e) {
            flutterBridge.log("HTML移除失败:"+e.message);
        }
    }

    //移除 css js，创建parseHTMLSafely前如果用不上 cssjs 建议移除
    function removeHTMLTags(htmlString) {
        // 移除script标签
        let result = htmlString.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
        // 移除style标签
        result = result.replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '');
        return result;
    }

</script>
<script>
  const flutterBridge = new FlutterJSBridge();
  const cache = new Cache();
  const http = new Http();
  const cookie = new Cookie();
  var baseurl="http://www.ychy.org"
  var contenttype="application/x-www-form-urlencoded"
  var header={
    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0",
    "Referer" : baseurl
  };
  async function search(key,page) {
    if(page > 1){
      return  "[]";
    }
    var url=baseurl+"/so.asp";
    var body="searchword="+(await  flutterBridge.utf8ToGbkUrlEncoded(key))+"&Submit=++"
    var get= await  http.Post(url,JSON.stringify(header),body,contenttype,true);
    flutterBridge.text(0,get.data )
    var books=[];
    var html = $.parseHTML( get.data );
    $(html).find(".ItemListbody").find("li").each(function(index) {
      var $element = $(this);
      var img = $element.find("img").attr('src');
      var book={
        "bookUrl":baseurl+$element.find("a").eq(1).attr('href'),
        "name": $element.find("span").text(),
        "author": $element.find("dd").eq(1).text(),
        "kind":$element.find("dd").eq(3).text(),
        "coverUrl":img,
        "intro":$element.find("dd").eq(9).text(),
        "tocUrl":baseurl+$element.find("a").eq(1).attr('href'),
        "wordCount":"",
        "type":1,
        "latestChapterTitle":$element.find("dd").eq(2).text(),
      }
      books.push(book);
    });
    return JSON.stringify(books);
  }

  async function info(bookurl) {
    var get=await http.Get(bookurl,JSON.stringify(header),true);
    flutterBridge.text(1,get.data )
    var html = $.parseHTML( get.data );
    var $html=$(html)
    var book={
      "bookUrl":bookurl,
      "name": $html.find(".content_title").find("h1").text(),
      "author": $html.find(".content_center").find("a").eq(1).text(),
      "kind": $html.find(".content_center").find("a").eq(2).text(),
      "coverUrl": $html.find(".content_right").find("img").attr('src'),
      "intro":$html.find(".txtbox").html(),
      "tocUrl":bookurl,
      "wordCount":"",
      "type":1,
      "latestChapterTitle":$html.find(".playlist").find("a").eq($html.find(".playlist").find("a").length-1).text(),
    }
    return JSON.stringify(book);
  }

  async function chapter(tocUrl) {
    var get = await http.Get(tocUrl, JSON.stringify(header), true);
    flutterBridge.text(2,get.data )
    var chapters=[];
    var html = $.parseHTML( get.data );
    $(html).find(".playlist").find("li").each(function(index) {
      var chapter={
        "name" :$(this).find("a").text(),
        "chapterId":baseurl+$(this).find("a").attr('href'),
        "index" :index,
        "isPay":false,
        "isVip":false,
        "isVolume":false,
        "tag":""
      };
      chapters.push(chapter);
    });
    return JSON.stringify(chapters);
  }

  async function content(url) {
    var re=await flutterBridge.webViewGetSource(url,"","","",JSON.stringify(header),".*\\.(mp3|m4a).*");
    flutterBridge.text(3,re )
    if(re.length > 1000){
      flutterBridge.log("webview 正则资源失败，可能是鸿蒙 bug，没关系我还有 jq")
      var html = $.parseHTML( re);
      return $(html).find("audio").attr('src');
    }
    return re;
  }

  async function getfinds() {
    var sort=[{
      title: "发现",
      url: "",
      type: 0,
    }];
    
    var str="盗墓探险::/list/45-{{page}}.html\n" +
            "官场刑侦::/list/14-{{page}}.html\n" +
            "网络玄幻::/list/52-{{page}}.html\n" +
            "历史军事::/list/15-{{page}}.html\n" +
            "人物传记::/list/16-{{page}}.html\n" +
            "儿童读物::/list/4-{{page}}.html\n" +
            "恐怖悬疑::/list/17-{{page}}.html\n" +
            "都市言情::/list/13-{{page}}.html\n" +
            "职场商战::/list/81-{{page}}.html\n" +
            "传统武侠::/list/12-{{page}}.html\n" +
            "相声戏曲::/list/7-{{page}}.html\n" +
            "百家讲坛::/list/32-{{page}}.html\n" +
            "经典评书::/list/3-{{page}}.html\n" +
            " 广 播 剧 ::/list/18-{{page}}.html\n" +
            "文艺戏曲::/list/53-{{page}}.html";
    
    // 解析分类字符串
    var categories = str.split('\n');
    categories.forEach(function(category) {
      if (category.trim() !== '') {
        // 按::分割获取标题和URL
        var parts = category.split('::');
        if (parts.length === 2) {
          // 添加到sort数组，去除标题中的多余空格
          sort.push({
            title: parts[0].trim(),
            url: parts[1].trim(),
            type: 0  // 保持type为0，与第一个元素一致
          });
        }
      }
    });

    return JSON.stringify(sort);
  }

  async function find(url,page) {
    var u=baseurl+url.replace("{{page}}",page)
    flutterBridge.log(u)
    var get=await http.Get(u,JSON.stringify(header),true);
    flutterBridge.text(0,get.data )
    var html = $.parseHTML( get.data );
    var books=[];
    try {
      $(html).find(".bx_channel_test").each(function(index) {
        var $element = $(this);
        var img = $element.find("img").attr('src');
        var book={
          "bookUrl":baseurl+$element.find("a").eq(0).attr('href'),
          "name": $element.find(".bx_channel_testname").find("a").text(),
          "author": $element.find("p").eq(2).text().replaceAll("作者:",""),
          "kind":"",
          "coverUrl":img,
          "intro":$element.find("p").eq(3).text(),
          "tocUrl":baseurl+$element.find("a").eq(0).attr('href'),
          "wordCount":"",
          "type":1,
          "latestChapterTitle":$element.find("p").eq(0).text(),
        }
        books.push(book);
      });
    }catch (e){

    }
    return JSON.stringify(books)
  }

  //返回http开头的则任务登录链接会跳webview，其他的会按照json解析显示弹窗
  async function getloginurl(){
      return baseurl;
  }

  //如果登录 url 为非 http 开头的弹窗界面，每次修改完弹窗就会执行此函数
  async function login(){

  }


  async function pay(bookurl,url){

  }

</script>
</html>